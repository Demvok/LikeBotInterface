<div class="content-wrapper">
  <!-- Header with Filters -->
  <header class="header-with-filters">
    <div class="header-top">
      <div class="header-title">
        <h2>Channels Management</h2>
        <span *ngIf="subscribedPhoneFilter" class="filter-badge">
          Filtering by Account: <strong>{{ subscribedPhoneFilter }}</strong>
          <button type="button" class="btn-clear-filter" (click)="clearSubscribedFilter()">‚úï</button>
        </span>
      </div>
      <div class="header-actions">
        <button class="btn-primary" (click)="openAddModal()" [disabled]="isGuest()">
          ‚ûï Add Channel
        </button>
        <button class="btn-secondary" (click)="refreshAll()">üîÑ Refresh</button>
      </div>
    </div>

    <!-- KPIs (Stage 3) -->
    <div class="kpi-row" *ngIf="statsLoading || statsError || channelStats">
      <div class="kpi-item" *ngIf="statsLoading">Loading KPIs...</div>
      <div class="kpi-item kpi-error" *ngIf="!statsLoading && statsError">{{ statsError }}</div>
      <ng-container *ngIf="!statsLoading && channelStats">
        <div class="kpi-item">Total: <strong>{{ channelStats.total_channels }}</strong></div>
        <div class="kpi-item">Public: <strong>{{ channelStats.public_channels }}</strong></div>
        <div class="kpi-item">Private: <strong>{{ channelStats.private_channels }}</strong></div>
        <div class="kpi-item">With reactions: <strong>{{ channelStats.channels_with_reactions }}</strong></div>
      </ng-container>
    </div>

    <div class="header-filters">
      <div class="filter-group">
        <input
          type="text"
          [(ngModel)]="searchChannelName"
          placeholder="Search by channel name..."
          class="form-control"
        />
      </div>

      <div class="filter-group">
        <select [(ngModel)]="selectedTag" class="form-control">
          <option value="">-- All Tags --</option>
          <option *ngFor="let tag of availableTags" [value]="tag">
            {{ tag }}
          </option>
        </select>
      </div>

      <div class="filter-actions">
        <button class="btn-primary" (click)="applyFilters()">üîç Apply</button>
        <button class="btn-secondary" (click)="clearFilters()">‚úñ Clear</button>
      </div>
    </div>
  </header>

  <!-- Messages -->
  <div class="message-container">
    <div class="success-message" *ngIf="successMessage">
      ‚úÖ {{ successMessage }}
    </div>
    <div class="error-message" *ngIf="errorMessage">
      ‚ùå {{ errorMessage }}
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-spinner" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading channels...</p>
  </div>

  <!-- Channels Table -->
  <main *ngIf="!loading" class="channels-table-container">
    <div class="table-wrapper">
      <table
        mat-table
        [dataSource]="channels"
        matSort
        class="channels-table"
      >
        <!-- Chat ID Column -->
        <ng-container matColumnDef="chat_id">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Chat ID</th>
          <td mat-cell *matCellDef="let channel">{{ channel.chat_id }}</td>
        </ng-container>

        <!-- Channel Name Column -->
        <ng-container matColumnDef="channel_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Channel Name</th>
          <td mat-cell *matCellDef="let channel">{{ channel.channel_name }}</td>
        </ng-container>

        <!-- Post Count Column (Stage 3) -->
        <ng-container matColumnDef="post_count">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Posts</th>
          <td mat-cell *matCellDef="let channel">
            {{ channel.post_count === null || channel.post_count === undefined ? '-' : channel.post_count }}
          </td>
        </ng-container>

        <!-- Private Column -->
        <ng-container matColumnDef="is_private">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Private</th>
          <td mat-cell *matCellDef="let channel">
            <span class="badge" [class]="channel.is_private ? 'badge-private' : 'badge-public'">
              {{ channel.is_private ? 'Private' : 'Public' }}
            </span>
          </td>
        </ng-container>

        <!-- Reactions Column -->
        <ng-container matColumnDef="has_enabled_reactions">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Reactions</th>
          <td mat-cell *matCellDef="let channel">
            <span class="badge" [class]="channel.has_enabled_reactions ? 'badge-enabled' : 'badge-disabled'">
              {{ channel.has_enabled_reactions ? 'Enabled' : 'Disabled' }}
            </span>
          </td>
        </ng-container>

        <!-- Tags Column -->
        <ng-container matColumnDef="tags">
          <th mat-header-cell *matHeaderCellDef>Tags</th>
          <td mat-cell *matCellDef="let channel">
            <div class="tags-container">
              <span class="tag" *ngFor="let tag of channel.tags">{{ tag }}</span>
              <span *ngIf="!channel.tags || channel.tags.length === 0" class="no-tags">No tags</span>
            </div>
          </td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Created</th>
          <td mat-cell *matCellDef="let channel">
            {{ formatDate(channel.created_at) }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let channel">
            <div class="actions-buttons">
              <button class="btn-view" (click)="viewChannelPosts(channel)" [disabled]="isGuest()" title="View posts from this channel">
                üìÑ
              </button>
              <button class="btn-view" (click)="viewChannelSubscribers(channel)" [disabled]="isGuest()" title="View subscribed accounts">
                üë•
              </button>
              <button class="btn-edit" (click)="openEditModal(channel)" [disabled]="isGuest()" title="Edit channel">
                ‚úèÔ∏è
              </button>
              <button class="btn-delete" (click)="openDeleteConfirm(channel)" [disabled]="isGuest()" title="Delete channel">
                üóëÔ∏è
              </button>
            </div>
          </td>
        </ng-container>

        <!-- Header and Row Definition -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <!-- Paginator -->
      <mat-paginator
        [pageSizeOptions]="[10, 15, 25, 100]"
        showFirstLastButtons
        aria-label="Select page"
      >
      </mat-paginator>
    </div>
  </main>
</div>

<!-- Subscribers Modal (Stage 3) -->
<div class="modal-overlay" *ngIf="showSubscribersModal" (click)="closeSubscribersModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Subscribers</h3>
      <button class="modal-close" (click)="closeSubscribersModal()">√ó</button>
    </div>

    <div class="modal-body">
      <div *ngIf="subscribersChannel" style="margin-bottom: 0.75rem; color: var(--color-text-light);">
        <strong style="color: var(--color-text);">{{ subscribersChannel.channel_name }}</strong>
        <span style="margin-left: 0.5rem;">({{ subscribersChannel.chat_id }})</span>
      </div>

      <div *ngIf="subscribersLoading" class="loading-spinner" style="padding: 1.5rem;">
        <mat-spinner diameter="30"></mat-spinner>
        <p>Loading subscribers...</p>
      </div>

      <div *ngIf="!subscribersLoading && subscribersError" class="error-message">
        ‚ùå {{ subscribersError }}
      </div>

      <div *ngIf="!subscribersLoading && !subscribersError">
        <div *ngIf="subscriberAccounts.length === 0" class="success-message" style="background: rgba(255, 255, 255, 0.06); border-left-color: var(--color-border);">
          No subscribers found.
        </div>

        <div *ngIf="subscriberAccounts.length > 0" class="subscribers-list">
          <div class="subscriber-row" *ngFor="let acc of subscriberAccounts">
            <div class="subscriber-main">
              <strong>{{ acc.phone_number }}</strong>
              <span class="subscriber-meta">{{ acc.status || 'UNKNOWN' }}</span>
            </div>
            <div class="subscriber-sub" *ngIf="acc.session_name">{{ acc.session_name }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeSubscribersModal()">Close</button>
    </div>
  </div>
</div>

<!-- Add/Edit Channel Modal -->
<div class="modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ isEditing ? 'Edit' : 'Add New' }} Channel</h3>
      <button class="modal-close" (click)="closeAddModal()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <div class="form-group">
        <label>Channel Name: <span class="required">*</span></label>
        <input
          type="text"
          [(ngModel)]="formData.channel_name"
          placeholder="Channel name"
          class="form-control"
        />
      </div>

      <div class="form-group">
        <label>Is Private:</label>
        <div class="toggle-group">
          <button
            type="button"
            class="toggle-btn"
            [class.active]="!formData.is_private"
            (click)="formData.is_private = false"
          >
            Public
          </button>
          <button
            type="button"
            class="toggle-btn"
            [class.active]="formData.is_private"
            (click)="formData.is_private = true"
          >
            Private
          </button>
        </div>
      </div>

      <div class="form-group">
        <label>Reactions:</label>
        <div class="toggle-group">
          <button
            type="button"
            class="toggle-btn"
            [class.active]="!formData.has_enabled_reactions"
            (click)="formData.has_enabled_reactions = false"
          >
            Disabled
          </button>
          <button
            type="button"
            class="toggle-btn"
            [class.active]="formData.has_enabled_reactions"
            (click)="formData.has_enabled_reactions = true"
          >
            Enabled
          </button>
        </div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" [(ngModel)]="formData.reactions_only_for_subscribers" />
          Reactions Only for Subscribers
        </label>
      </div>

      <div class="form-group">
        <label>Discussion Chat ID:</label>
        <input
          type="number"
          [(ngModel)]="formData.discussion_chat_id"
          placeholder="Optional"
          class="form-control"
        />
      </div>

      <div class="form-group">
        <label>Tags (comma-separated):</label>
        <input
          type="text"
          [(ngModel)]="tagsInput"
          placeholder="e.g., crypto, news, tech"
          class="form-control"
        />
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeAddModal()">Cancel</button>
      <button class="btn-primary" (click)="saveChannel()">
        {{ isEditing ? 'Update Channel' : 'Add Channel' }}
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="closeDeleteConfirm()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Delete Channel</h3>
      <button class="modal-close" (click)="closeDeleteConfirm()">√ó</button>
    </div>

    <div class="modal-body">
      <p>Are you sure you want to delete channel <strong>{{ deleteChannelName }}</strong> (ID: {{ deleteChannelId }})?</p>
      <p style="color: #ef4444; font-size: 0.9rem; margin-top: 1rem;">
        ‚ö†Ô∏è This action cannot be undone.
      </p>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeDeleteConfirm()">Cancel</button>
      <button class="btn-delete" (click)="confirmDelete()">Delete Channel</button>
    </div>
  </div>
</div>
