<div class="content-wrapper">
  <header>
    <div class="header-title">
      <a routerLink="/accounts" class="return-link">â† Accounts</a>
      <h2>Task Report #{{taskId}}</h2>
      
      <div class="control-group">
        <label>Select Run:</label>
        <select [(ngModel)]="selectedRunId" (change)="onRunChange()" [disabled]="isLoadingRuns || availableRuns.length === 0">
          @if (availableRuns.length === 0) {
            <option value="">No runs available</option>
          } @else {
            @for (run of availableRuns; track run.run_id) {
              <option [value]="run.run_id">
                {{run.started_at | date:'MMM dd, yyyy HH:mm'}} - {{run.event_count}} events ({{run.status}})
              </option>
            }
          }
        </select>
      </div>
      
      <button (click)="loadReportData()" [disabled]="isLoading || !selectedRunId" class="refresh-btn">
        <mat-icon [class.app-spin]="isLoading" aria-hidden="true">refresh</mat-icon>
        Refresh
      </button>
    </div>

    <!-- Report Type and Client Filter -->
    <div class="controls-section">
      <div class="control-group">
        <label>Report Type:</label>
        <select [(ngModel)]="reportType" (change)="onReportTypeChange()" [disabled]="isLoading || !selectedRunId">
          <option value="success">Success Only</option>
          <option value="errors">Errors Only</option>
          <option value="all">All Events</option>
        </select>
      </div>

      <div class="control-group">
        <label>Client:</label>
        <select [(ngModel)]="filters.client" (change)="onFilterChange()">
          <option value="">All Clients</option>
          @for (client of uniqueClients; track client) {
            <option [value]="client">{{formatPhoneNumber(client)}}</option>
          }
        </select>
      </div>
    </div>
  </header>

  <main>
    @if (isLoadingRuns) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading available runs...</p>
      </div>
    } @else if (availableRuns.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">ğŸ“Š</div>
        <h3>No runs available</h3>
        <p>This task hasn't been executed yet.</p>
      </div>
    } @else if (isLoading) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading report data...</p>
      </div>
    } @else if (error) {
      <div class="error-state">
        <div class="error-icon">âš ï¸</div>
        <h3>Failed to load report</h3>
        <p>{{error}}</p>
        <button (click)="loadReportData()" class="retry-btn">Try Again</button>
      </div>
    } @else if (!reportData || reportData.report.events.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">ğŸ“Š</div>
        <h3>No report data available</h3>
        <p>No events found for the selected report type.</p>
      </div>
    } @else {
      <!-- Events Table -->
      <div class="table-controls">
        <div class="results-info">
          Showing {{(currentPage - 1) * eventsPerPage + 1}}-{{Math.min(currentPage * eventsPerPage, filteredEvents.length)}} 
          of {{filteredEvents.length}} events
        </div>
        
        <div class="page-size-control">
          <label>Events per page:</label>
          <select [(ngModel)]="eventsPerPage" (change)="currentPage = 1">
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
            <option [value]="100">100</option>
          </select>
        </div>
      </div>

      <div class="events-table-container">
        <table class="events-table">
          <thead>
            <tr>
              <th (click)="onSort('datetime')" class="sortable">
                Timestamp 
                @if (sortBy === 'datetime') {
                  <span class="sort-indicator">{{sortDirection === 'asc' ? 'â†‘' : 'â†“'}}</span>
                }
              </th>
              <th (click)="onSort('client')" class="sortable">
                Client
                @if (sortBy === 'client') {
                  <span class="sort-indicator">{{sortDirection === 'asc' ? 'â†‘' : 'â†“'}}</span>
                }
              </th>
              <th>Post</th>
              <th (click)="onSort('palette')" class="sortable">
                Reaction
                @if (sortBy === 'palette') {
                  <span class="sort-indicator">{{sortDirection === 'asc' ? 'â†‘' : 'â†“'}}</span>
                }
              </th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody>
            @for (event of getPaginatedEvents(); track trackByEvent($index, event)) {
              <tr [class]="event.error ? 'error-row' : ''">
                <td class="timestamp-cell">
                  {{formatDate(event.datetime || event.ts)}}
                </td>
                <td class="client-cell">
                  <div class="client-info">
                    <span class="phone-number">{{formatPhoneNumber(event.client || '')}}</span>
                  </div>
                </td>
                <td class="post-cell">
                  @if (event.message_link) {
                    <a [href]="event.message_link" target="_blank" class="post-link">
                      View Post
                    </a>
                  } @else {
                    <span class="no-link">N/A</span>
                  }
                </td>
                <td class="reaction-cell">
                  @if (event.palette) {
                    <span [class]="'reaction-badge ' + event.palette">
                      @if (event.palette === 'positive') {
                        <span class="reaction-emoji">ğŸ‘</span> Positive
                      } @else if (event.palette === 'negative') {
                        <span class="reaction-emoji">ğŸ‘</span> Negative
                      } @else {
                        {{event.palette}}
                      }
                    </span>
                  } @else {
                    <span class="no-link">N/A</span>
                  }
                </td>
                <td class="message-cell">
                  <div class="message-content" (click)="openMessageModal(event)">
                    <span class="message-text">{{event.message}}</span>
                    @if (event.message && event.message.length > 50) {
                      <span class="expand-icon">â†—</span>
                    }
                  </div>
                  @if (event.error) {
                    <div class="error-badge">âš ï¸ {{event.error}}</div>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      @if (getTotalPages() > 1) {
        <div class="pagination">
          <button (click)="prevPage()" [disabled]="currentPage === 1" class="page-btn">
            â€¹ Previous
          </button>
          
          @if (getVisiblePages()[0] > 1) {
            <button (click)="goToPage(1)" class="page-btn">1</button>
            @if (getVisiblePages()[0] > 2) {
              <span class="page-ellipsis">...</span>
            }
          }
          
          @for (page of getVisiblePages(); track page) {
            <button 
              (click)="goToPage(page)" 
              [class]="'page-btn ' + (currentPage === page ? 'active' : '')">
              {{page}}
            </button>
          }
          
          @if (getVisiblePages()[getVisiblePages().length - 1] < getTotalPages()) {
            @if (getVisiblePages()[getVisiblePages().length - 1] < getTotalPages() - 1) {
              <span class="page-ellipsis">...</span>
            }
            <button (click)="goToPage(getTotalPages())" class="page-btn">{{getTotalPages()}}</button>
          }
          
          <button (click)="nextPage()" [disabled]="currentPage === getTotalPages()" class="page-btn">
            Next â€º
          </button>
        </div>
      }
    }
  </main>

  <footer>
    @if (reportData && !isLoading && selectedRunId) {
      <div class="footer-stats">
        Report Type: <strong>{{reportType}}</strong> | 
        {{filteredEvents.length}} events | 
        Run: <span class="run-id-footer">{{selectedRunId}}</span>
      </div>
    }
  </footer>

  <!-- Message Modal -->
  @if (selectedMessage) {
    <div class="modal-overlay" (click)="closeMessageModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Full Message</h3>
          <button class="close-btn" (click)="closeMessageModal()">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="message-display">
            {{selectedMessage.message}}
          </div>
          @if (selectedMessage.error) {
            <div class="error-section">
              <h4>Error Details:</h4>
              <div class="error-display">
                {{selectedMessage.error}}
              </div>
            </div>
          }
          <div class="event-details">
            <div class="detail-item">
              <span class="detail-label">Timestamp:</span>
              <span class="detail-value">{{formatDate(selectedMessage.datetime || selectedMessage.ts)}}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Client:</span>
              <span class="detail-value">{{formatPhoneNumber(selectedMessage.client || '')}}</span>
            </div>
            @if (selectedMessage.palette) {
              <div class="detail-item">
                <span class="detail-label">Reaction:</span>
                <span class="detail-value">
                  @if (selectedMessage.palette === 'positive') {
                    ğŸ‘ Positive
                  } @else if (selectedMessage.palette === 'negative') {
                    ğŸ‘ Negative
                  } @else {
                    {{selectedMessage.palette}}
                  }
                </span>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>