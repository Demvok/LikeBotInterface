<div class="content-wrapper">
  <header>
    <div class="header-title">
      <h2>Task Report #{{taskId}}</h2>
      
      <div class="control-group">
        <label>Select Run:</label>
        <select [(ngModel)]="selectedRunId" (change)="onRunChange()" [disabled]="isLoadingRuns || availableRuns.length === 0">
          @if (availableRuns.length === 0) {
            <option value="">No runs available</option>
          } @else {
            @for (run of availableRuns; track run.run_id) {
              <option [value]="run.run_id">
                {{run.started_at | date:'MMM dd, yyyy HH:mm'}} - {{run.event_count}} events ({{run.status}})
              </option>
            }
          }
        </select>
      </div>
      
      <button (click)="loadReportData()" [disabled]="isLoading || !selectedRunId" class="refresh-btn">
        <span [class.spinning]="isLoading">‚Üª</span> Refresh
      </button>
    </div>

    <!-- Report Type and Client Filter -->
    <div class="controls-section">
      <div class="control-group">
        <label>Report Type:</label>
        <select [(ngModel)]="reportType" (change)="onReportTypeChange()" [disabled]="isLoading || !selectedRunId">
          <option value="success">Success Only</option>
          <option value="errors">Errors Only</option>
          <option value="all">All Events</option>
        </select>
      </div>

      <div class="control-group">
        <label>Client:</label>
        <select [(ngModel)]="filters.client" (change)="onFilterChange()">
          <option value="">All Clients</option>
          @for (client of uniqueClients; track client) {
            <option [value]="client">{{formatPhoneNumber(client)}}</option>
          }
        </select>
      </div>
    </div>
  </header>

  <main>
    @if (isLoadingRuns) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading available runs...</p>
      </div>
    } @else if (availableRuns.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üìä</div>
        <h3>No runs available</h3>
        <p>This task hasn't been executed yet.</p>
      </div>
    } @else if (isLoading) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading report data...</p>
      </div>
    } @else if (error) {
      <div class="error-state">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3>Failed to load report</h3>
        <p>{{error}}</p>
        <button (click)="loadReportData()" class="retry-btn">Try Again</button>
      </div>
    } @else if (!reportData || reportData.report.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üìä</div>
        <h3>No report data available</h3>
        <p>No events found for the selected report type.</p>
      </div>
    } @else {
      <!-- Events Table -->
      <div class="table-controls">
        <div class="results-info">
          Showing {{(currentPage - 1) * eventsPerPage + 1}}-{{Math.min(currentPage * eventsPerPage, filteredEvents.length)}} 
          of {{filteredEvents.length}} events
        </div>
        
        <div class="page-size-control">
          <label>Events per page:</label>
          <select [(ngModel)]="eventsPerPage" (change)="currentPage = 1">
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
            <option [value]="100">100</option>
          </select>
        </div>
      </div>

      <div class="events-table-container">
        <table class="events-table">
          <thead>
            <tr>
              <th (click)="onSort('datetime')" class="sortable">
                Timestamp 
                @if (sortBy === 'datetime') {
                  <span class="sort-indicator">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
                }
              </th>
              <th (click)="onSort('client')" class="sortable">
                Client
                @if (sortBy === 'client') {
                  <span class="sort-indicator">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
                }
              </th>
              <th>Post</th>
              <th (click)="onSort('palette')" class="sortable">
                Reaction
                @if (sortBy === 'palette') {
                  <span class="sort-indicator">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
                }
              </th>
              <th>Message</th>
              @if (reportType === 'all' || reportType === 'success') {
                <th>Status</th>
              }
              @if (reportType === 'errors') {
                <th>Error Details</th>
              }
            </tr>
          </thead>
          <tbody>
            @for (event of getPaginatedEvents(); track trackByEvent($index, event)) {
              <tr [class]="event.error ? 'error-row' : ''">
                <td class="timestamp-cell">
                  {{formatDate(event.datetime || event.ts)}}
                </td>
                <td class="client-cell">
                  <div class="client-info">
                    <span class="phone-number">{{formatPhoneNumber(event.client || '')}}</span>
                  </div>
                </td>
                <td class="post-cell">
                  @if (event.message_link) {
                    <a [href]="event.message_link" target="_blank" class="post-link">
                      View Post
                    </a>
                  } @else {
                    <span class="no-link">N/A</span>
                  }
                </td>
                <td class="reaction-cell">
                  @if (event.palette) {
                    <span [class]="'reaction-badge ' + event.palette">
                      @if (event.palette === 'positive') {
                        <span class="reaction-emoji">üëç</span> Positive
                      } @else if (event.palette === 'negative') {
                        <span class="reaction-emoji">üëé</span> Negative
                      } @else {
                        {{event.palette}}
                      }
                    </span>
                  } @else {
                    <span class="no-link">N/A</span>
                  }
                </td>
                <td class="message-cell">
                  <div class="message-content">
                    {{event.message}}
                  </div>
                </td>
                @if (reportType === 'all' || reportType === 'success') {
                  <td class="status-cell">
                    @if (event.error) {
                      <span class="status-badge error">
                        ‚ùå Error
                      </span>
                    } @else {
                      <span class="status-badge success">
                        ‚úÖ Success
                      </span>
                    }
                  </td>
                }
                @if (reportType === 'errors') {
                  <td class="error-details-cell">
                    <div class="error-content">
                      {{event.error}}
                    </div>
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      @if (getTotalPages() > 1) {
        <div class="pagination">
          <button (click)="prevPage()" [disabled]="currentPage === 1" class="page-btn">
            ‚Äπ Previous
          </button>
          
          @if (getVisiblePages()[0] > 1) {
            <button (click)="goToPage(1)" class="page-btn">1</button>
            @if (getVisiblePages()[0] > 2) {
              <span class="page-ellipsis">...</span>
            }
          }
          
          @for (page of getVisiblePages(); track page) {
            <button 
              (click)="goToPage(page)" 
              [class]="'page-btn ' + (currentPage === page ? 'active' : '')">
              {{page}}
            </button>
          }
          
          @if (getVisiblePages()[getVisiblePages().length - 1] < getTotalPages()) {
            @if (getVisiblePages()[getVisiblePages().length - 1] < getTotalPages() - 1) {
              <span class="page-ellipsis">...</span>
            }
            <button (click)="goToPage(getTotalPages())" class="page-btn">{{getTotalPages()}}</button>
          }
          
          <button (click)="nextPage()" [disabled]="currentPage === getTotalPages()" class="page-btn">
            Next ‚Ä∫
          </button>
        </div>
      }
    }
  </main>

  <footer>
    @if (reportData && !isLoading && selectedRunId) {
      <div class="footer-stats">
        Report Type: <strong>{{reportType}}</strong> | 
        {{filteredEvents.length}} events | 
        Run: <span class="run-id-footer">{{selectedRunId}}</span>
      </div>
    }
  </footer>
</div>