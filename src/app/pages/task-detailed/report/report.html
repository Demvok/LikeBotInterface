<div class="content-wrapper">
  <header>
    <div class="header-title">
      <h2>Task Report #{{taskId}}</h2>
      <span class="run-id" *ngIf="reportData">Run ID: {{reportData.run_id}}</span>
      <button (click)="loadReportData()" [disabled]="isLoading" class="refresh-btn">
        <span [class.spinning]="isLoading">‚Üª</span> Refresh
      </button>
    </div>

    <!-- Stats Overview -->
    @if (reportData && !isLoading) {
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">{{stats.totalEvents}}</div>
          <div class="stat-label">Total Events</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{stats.uniqueClients}}</div>
          <div class="stat-label">Unique Clients</div>
        </div>
        <div class="stat-card positive">
          <div class="stat-number">{{stats.positiveReactions}}</div>
          <div class="stat-label">Positive</div>
        </div>
        <div class="stat-card negative">
          <div class="stat-number">{{stats.negativeReactions}}</div>
          <div class="stat-label">Negative</div>
        </div>
        <div class="stat-card error">
          <div class="stat-number">{{stats.errorCount}}</div>
          <div class="stat-label">Errors</div>
        </div>
        <div class="stat-card success">
          <div class="stat-number">{{stats.successRate | number:'1.1-1'}}%</div>
          <div class="stat-label">Success Rate</div>
        </div>
      </div>
    }

    <!-- Filters -->
    @if (reportData && !isLoading) {
      <div class="filters-section">
        <div class="filters-grid">
          <div class="filter-group">
            <label>Client:</label>
            <select [(ngModel)]="filters.client" (change)="onFilterChange()">
              <option value="">All Clients</option>
              @for (client of uniqueClients; track client) {
                <option [value]="client">{{formatPhoneNumber(client)}}</option>
              }
            </select>
          </div>
          
          <div class="filter-group">
            <label>Reaction:</label>
            <select [(ngModel)]="filters.palette" (change)="onFilterChange()">
              <option value="">All Reactions</option>
              <option value="positive">Positive</option>
              <option value="negative">Negative</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>From Date:</label>
            <input type="date" [(ngModel)]="filters.startDate" (change)="onFilterChange()">
          </div>
          
          <div class="filter-group">
            <label>To Date:</label>
            <input type="date" [(ngModel)]="filters.endDate" (change)="onFilterChange()">
          </div>
          
          <div class="filter-group">
            <label>Status:</label>
            <select [(ngModel)]="filters.hasError" (change)="onFilterChange()">
              <option [ngValue]="null">All Events</option>
              <option [ngValue]="false">Success Only</option>
              <option [ngValue]="true">Errors Only</option>
            </select>
          </div>
          
          <button (click)="clearFilters()" class="clear-filters-btn">
            Clear Filters
          </button>
        </div>
      </div>
    }
  </header>

  <main>
    @if (isLoading) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading report data...</p>
      </div>
    } @else if (error) {
      <div class="error-state">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3>Failed to load report</h3>
        <p>{{error}}</p>
        <button (click)="loadReportData()" class="retry-btn">Try Again</button>
      </div>
    } @else if (!reportData || reportData.report.events.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üìä</div>
        <h3>No report data available</h3>
        <p>This task hasn't generated any report data yet.</p>
      </div>
    } @else {
      <!-- Events Table -->
      <div class="table-controls">
        <div class="results-info">
          Showing {{(currentPage - 1) * eventsPerPage + 1}}-{{Math.min(currentPage * eventsPerPage, filteredEvents.length)}} 
          of {{filteredEvents.length}} events
        </div>
        
        <div class="page-size-control">
          <label>Events per page:</label>
          <select [(ngModel)]="eventsPerPage" (change)="currentPage = 1">
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
            <option [value]="100">100</option>
          </select>
        </div>
      </div>

      <div class="events-table-container">
        <table class="events-table">
          <thead>
            <tr>
              <th (click)="onSort('datetime')" class="sortable">
                Timestamp 
                @if (sortBy === 'datetime') {
                  <span class="sort-indicator">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
                }
              </th>
              <th (click)="onSort('client')" class="sortable">
                Client
                @if (sortBy === 'client') {
                  <span class="sort-indicator">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
                }
              </th>
              <th>Post</th>
              <th (click)="onSort('palette')" class="sortable">
                Reaction
                @if (sortBy === 'palette') {
                  <span class="sort-indicator">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
                }
              </th>
              <th>Message</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            @for (event of getPaginatedEvents(); track trackByEvent($index, event)) {
              <tr [class]="event.error ? 'error-row' : ''">
                <td class="timestamp-cell">
                  {{formatDate(event.datetime)}}
                </td>
                <td class="client-cell">
                  <div class="client-info">
                    <span class="phone-number">{{formatPhoneNumber(event.client)}}</span>
                  </div>
                </td>
                <td class="post-cell">
                  @if (event.message_link) {
                    <a [href]="event.message_link" target="_blank" class="post-link">
                      View Post
                    </a>
                  } @else {
                    <span class="no-link">N/A</span>
                  }
                </td>
                <td class="reaction-cell">
                  <span [class]="'reaction-badge ' + event.palette">
                    @if (event.palette === 'positive') {
                      <span class="reaction-emoji">üëç</span> Positive
                    } @else if (event.palette === 'negative') {
                      <span class="reaction-emoji">üëé</span> Negative
                    } @else {
                      {{event.palette}}
                    }
                  </span>
                </td>
                <td class="message-cell">
                  <div class="message-content">
                    {{event.message}}
                  </div>
                </td>
                <td class="status-cell">
                  @if (event.error) {
                    <span class="status-badge error">
                      ‚ùå Error
                    </span>
                    <div class="error-tooltip">
                      {{event.error}}
                    </div>
                  } @else {
                    <span class="status-badge success">
                      ‚úÖ Success
                    </span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      @if (getTotalPages() > 1) {
        <div class="pagination">
          <button (click)="prevPage()" [disabled]="currentPage === 1" class="page-btn">
            ‚Äπ Previous
          </button>
          
          @if (getVisiblePages()[0] > 1) {
            <button (click)="goToPage(1)" class="page-btn">1</button>
            @if (getVisiblePages()[0] > 2) {
              <span class="page-ellipsis">...</span>
            }
          }
          
          @for (page of getVisiblePages(); track page) {
            <button 
              (click)="goToPage(page)" 
              [class]="'page-btn ' + (currentPage === page ? 'active' : '')">
              {{page}}
            </button>
          }
          
          @if (getVisiblePages()[getVisiblePages().length - 1] < getTotalPages()) {
            @if (getVisiblePages()[getVisiblePages().length - 1] < getTotalPages() - 1) {
              <span class="page-ellipsis">...</span>
            }
            <button (click)="goToPage(getTotalPages())" class="page-btn">{{getTotalPages()}}</button>
          }
          
          <button (click)="nextPage()" [disabled]="currentPage === getTotalPages()" class="page-btn">
            Next ‚Ä∫
          </button>
        </div>
      }
    }
  </main>

  <footer>
    @if (reportData && !isLoading) {
      <div class="footer-stats">
        Report generated with {{stats.totalEvents}} total events across {{stats.uniqueClients}} clients
        @if (reportData.run_id) {
          | Run: {{reportData.run_id}}
        }
      </div>
    }
  </footer>
</div>